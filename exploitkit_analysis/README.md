# SIEM Lab: 2015-03-09 Malware Traffic Analysis PCAP
 
## Introduction

This pcap is about investigating exploit kit activity on a victim’s device. Exploit kits are tools used for automatically managing and deploying malware without requiring advanced knowledge of the exploits being used.
 
To get started, I upgraded from zeek logs on my terminal to a much nicer UI with Kibana dashboards. I wanted to get the experience of using a SIEM but wanted to start with something more barebones to avoid being overwhelmed by excess features.
 
## Setup
My setup is a Suricata, Filebeat, Elasticsearch, and Kibana stack. Suricata can be run alone just like zeek, but I found visualizing the alerts with the help of a dashboard was a lot easier and allowed me to focus on the task at hand, rather than constantly filtering on my terminal.
 
## Analysis
With my stack setup, I ran Suricata on the pcap and exported the logs to my Kibana dashboard as shown below. One thing to note while using the dashboard is that timestamps are based on the actual packets and note when the logs were imported (took me a day to figure out I had to set the date back to 2015).
 
![Kibana dashboard of alerts](/media/image1.png)
 
Before we get started, let’s take a look at the questions outlined for this exercise.
 
![Questions for exercise](/media/image2.png)
 
Firstly, let’s get all the victim’s information. I began by looking for the most popular IP addresses (both source and destination) and easily found 172.16.138.158 as the likely source IP. Just to double check, I ran a KQL query to filter out any unrelated alerts to this IP and got none, which confirmed my suspicion.
 
![IP activity search](/media/image3.png)

![No alerts for anything other than specific IP](/media/image4.png)

 
However, I began to realize Kibana, though great for visualization, probably wasn’t the best tool for low-level analysis. So, I booted up wireshark and looked through some LLNMR logs (alternative device lookup protocol only on local networks if DNS doesn’t work).

![Victim mac and IP in LLNMR request](/media/image5.png)

Now that we’ve found the victim’s IP address, hostname, and mac address, we can get back to analyzing our suricata alerts on kibana.

![Suricata alerts](/media/image6.png)

Now there are multiple alerts for this PCAP, but only some of them are relevant. In general, I didn’t consider ET INFO, POLICY, or HUNTING to be important in the beginning. Instead, MALWARE seemed to be the target, especially considering the alert category fell under Network Trojan, which is malware disguised as harmless, fed to the victim.

![Looking for MALWARE alerts](/media/image7.png)

To begin, I filtered the ET MALWARE alerts and added columns for rule category, related ip, request method, and alert metadata. This gave me a few IP addresses and to find the first one I ranked by oldest time stamp to get 77.108.238.169 as my first suspicious IP address.


![Suspicious GET request with dat0sd1.exe](/media/image8.png)


Opening it up in wireshark, I found a very interesting HTTP request. Not only did it not have a hostname (thereby bypassing DNS by directing the request directly to the victim IP) or a response in wireshark, but it’s route was dat0sd1.exe. Immediately this confirmed mine (and suricata’s) suspicion of a network trojan, as it’s likely the victim’s PC ran the exe which delivered the malware.

But given there was no response to this GET request, I wondered if it didn’t work. Maybe this was just one of many other requests used to drop the trojan. My suspicions were confirmed when I filtered for other such http GET requests and found these from multiple different IPs.

![Multiple GET attempts to deliver EK](/media/image9.png)

Some of them had no response (like the first), some got 404s, but the 2nd last one (119.238.10.9) got a 200 response, indicating that this was the successful IP to breach and drop the malware.

![EK dropped with obfuscated js](/media/image10.png)

From wireshark, I could confirm this IP dropped the malware to the victim’s device. However, looking back at the questions, it asks for a compromised website that kicked off the chain of events. I couldn’t find a domain name that this IP was using and realized it was communicating directly using the victim’s IP.

After further research into exploit kits, I discovered that the drop phase is close to the last in the sequence of attack steps. Meaning, there must have been a website that directed the victim to accidentally perform this GET request to download the malware.

I decided to look at http requests made before the first /pods GET request and found a few odd GET requests. Alone they aren’t too suspicious, but given the context I decided to take a look at the IP and associated domain name.

![Investigating before malicious GET request](/media/image11.png)


I couldn’t find anything suspicious on soquumaihi.co.vu on VirusTotal but combined with the URl it came up as suspicious malware. I wasn’t entirely certain, but decided that this was the Exploit Kit website for the moment. 

Now I needed to find the website that kicked off this infection in the first place. Tracking back the requests to the first one (shown above), I found the referred to be fortunet.biz. I decided to take a look at it.

Turns out, most packets preceding this are from the fortunet.biz host, which pretty much leaves little room for any other possible compromised website. But I needed more proof, which I eventually found looking through some odd packets.

![JS injected to perform malicious GET request](/media/image12.png)


Scrolling up, I found an odd /fb/portal request with a weirdly named php file and random id. This set of alarm flags and I followed the conversation, only to find the response was a single javascript line.

The document.write line confirms that the response stealthily injects an iframe to point at another domain, which happens to be the suspected EK website, without the user knowing. This was the smoking gun tying all the steps and websites together.

However, I still didn’t understand how the soquumaihi.co.vu related to the following dat0sd1.exe request. I decided to take a look at the obfuscated js, and looking at the headers, found that it was a ZWS file.

![ZWS file delivered](/media/image13.png)

After some digging online, I found that ZWS files contain action scripts which run in Adobe Flash Player. Since flash player was commonly used, and often outdated back in 2015, it made for the perfect cover for EK exploits, without raising any red flags.

This was the final clue, proving that soquumaihi.co.vu was indeed the EK website, despite not having any visible connection to the following malicious request (because it was embedded in the obfuscated shellcode).


## Infection Outline
* The victim is on fortunet.biz, which is a normal and usually safe website, browsing. However, one of the pages is compromised and kicks off the chain of EK infection by silently redirecting user to soquumaihi.co.vu.

* The soquumaihi.co.vu domain (EK website) sends odd GET requests with long, obfuscated payloads to the victim’s computer, which happens to be a ZWS flash file, exploiting the flash player and runs shellcode to construct a HTTP request.

* HTTP request is sent using the victim IP directly, bypassing DNS detection, and injects the dat0sd1.exe file with EK malware.

Now the last question remaining is which EK was used. Though I couldn’t pinpoint an exact answer, upon searching up on Kelhios.F and Flash exploits, I found an article detailing Nuclear EK malware targeting websites of the International Council for Women. 

A few other articles seemed to pop up on this, and it seems like Nuclear EKs used a lot of Flash file malware back in 2015, which finally led me to conclude that Nuclear was the exploit kit used here.

And that’s all for this exercise! It was a great introduction to suricata alerts and working with dashboards. However, it seems like I had to rely more on wireshark as suricata alerts for EK activity don't really exist anymore (since these attacks are outdated) and so it didn’t help too much. With older suricata alert signatures, I wouldn’t found it was a Nuclear EK straightaway.

Regardless, it was a good introduction to alerts and revision of wireshark. Thanks for reading my writeup!
